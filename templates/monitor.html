{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <!-- Page header -->
        <div class="text-center mb-4">
            <h1 class="text-white fw-bold">Job Monitoring</h1>
            <p class="text-white-50 mb-0">Track your scraping progress in real-time</p>
        </div>
        
        <div class="card">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-0"><i class="fas fa-tasks"></i> Scraping Job</h4>
                        <p class="mb-0 opacity-75">Job ID: {{ job.job_id }}</p>
                    </div>
                    <span id="status-badge" class="badge bg-info fs-6">{{ job.status.title() }}</span>
                </div>
            </div>
            <div class="card-body">
                <!-- Job information -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6><i class="fas fa-search me-2 text-primary"></i> Search Query</h6>
                        <p class="text-muted">{{ job.search_query }}</p>
                    </div>
                    <div class="col-md-3">
                        <h6><i class="fas fa-list-ol me-2 text-primary"></i> Target Results</h6>
                        <p class="text-muted">{{ job.total_results }}</p>
                    </div>
                    <div class="col-md-3">
                        <h6><i class="fas fa-file me-2 text-primary"></i> Output File</h6>
                        <p class="text-muted">{{ job.output_file }}</p>
                    </div>
                </div>

                <!-- Enhanced progress visualization -->
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6><i class="fas fa-chart-line me-2 text-primary"></i> Progress</h6>
                        <span id="progress-text" class="fw-bold">{{ "%.1f"|format(job.progress) }}%</span>
                    </div>
                    <div class="progress mb-2">
                        <div id="progress-bar" 
                             class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" 
                             data-progress="{{ job.progress }}">
                        </div>
                    </div>
                    <div class="d-flex justify-content-between">
                        <small class="text-muted">
                            <span id="result-count">{{ job.result_count }}</span> results found
                        </small>
                        <small class="text-muted" id="eta">
                            <!-- ETA will be calculated and displayed here -->
                        </small>
                    </div>
                </div>

                <!-- Real-time stats -->
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title text-primary">
                                    <i class="fas fa-clock me-2"></i> Started
                                </h6>
                                <p class="card-text mb-0" id="start-time">
                                    {{ job.start_time.strftime('%Y-%m-%d %H:%M:%S') }}
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title text-primary">
                                    <i class="fas fa-flag-checkered me-2"></i> Completed
                                </h6>
                                <p class="card-text mb-0" id="end-time">
                                    {% if job.end_time %}
                                        {{ job.end_time.strftime('%Y-%m-%d %H:%M:%S') }}
                                    {% else %}
                                        In progress...
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Error section -->
                <div id="error-section" class="alert alert-danger d-none">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i> Error</h6>
                    <p id="error-message" class="mb-0"></p>
                </div>

                <!-- Action panel -->
                <div id="action-buttons" class="d-flex flex-wrap gap-2">
                    {% if job.status == 'completed' %}
                        <a href="{{ url_for('download_results', job_id=job.job_id) }}" 
                           class="btn btn-success">
                            <i class="fas fa-download me-2"></i> Download Results
                        </a>
                        <button type="button" 
                                class="btn btn-info" 
                                onclick="previewResults()">
                            <i class="fas fa-eye me-2"></i> Preview Results
                        </button>
                    {% endif %}
                    <a href="{{ url_for('index') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i> Back to Home
                    </a>
                </div>
            </div>
        </div>

        <!-- Job details card -->
        <div class="card mt-4">
            <div class="card-header">
                <h5><i class="fas fa-info-circle me-2"></i> Job Details</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <tbody>
                            <tr>
                                <td><strong>Job ID</strong></td>
                                <td>{{ job.job_id }}</td>
                            </tr>
                            <tr>
                                <td><strong>Status</strong></td>
                                <td><span id="details-status">{{ job.status.title() }}</span></td>
                            </tr>
                            <tr>
                                <td><strong>Search Query</strong></td>
                                <td>{{ job.search_query }}</td>
                            </tr>
                            <tr>
                                <td><strong>Target Results</strong></td>
                                <td>{{ job.total_results }}</td>
                            </tr>
                            <tr>
                                <td><strong>Output File</strong></td>
                                <td>{{ job.output_file }}</td>
                            </tr>
                            <tr>
                                <td><strong>Started</strong></td>
                                <td>{{ job.start_time.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                            </tr>
                            {% if job.end_time %}
                            <tr>
                                <td><strong>Completed</strong></td>
                                <td>{{ job.end_time.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Results Preview Modal -->
        <div class="modal fade" id="previewModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-table me-2"></i> Results Preview
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div id="preview-content">
                            <div class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const jobId = "{{ job.job_id }}";
    const initialProgress = parseFloat("{{ job.progress }}");
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const statusBadge = document.getElementById('status-badge');
    const detailsStatus = document.getElementById('details-status');
    const resultCountEl = document.getElementById('result-count');
    const etaElement = document.getElementById('eta');
    const endTimeElement = document.getElementById('end-time');
    const errorSection = document.getElementById('error-section');
    const errorMessageEl = document.getElementById('error-message');
    const actionButtons = document.getElementById('action-buttons');
    let latestMetrics = null;
    let latestPreviewRecords = [];

    if (progressBar) {
        progressBar.style.width = initialProgress + '%';
        progressBar.setAttribute('data-progress', initialProgress);
    }
    if (progressText && !Number.isNaN(initialProgress)) {
        progressText.textContent = initialProgress.toFixed(1) + '%';
    }

    const socket = io();

    function ensureActionsForCompletion() {
        if (!actionButtons) {
            return;
        }
        if (!document.querySelector(`a[href="/download/${jobId}"]`)) {
            actionButtons.innerHTML = `
                <a href="/download/${jobId}" class="btn btn-success">
                    <i class="fas fa-download me-2"></i> Download Results
                </a>
                <button type="button" class="btn btn-info" onclick="previewResults()">
                    <i class="fas fa-eye me-2"></i> Preview Results
                </button>
                <a href="/" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-2"></i> Back to Home
                </a>
            `;
        }
    }

    function updateStatus(status, errorMessage) {
        if (!statusBadge || !detailsStatus) {
            return;
        }
        const safeStatus = status || 'running';
        const statusText = safeStatus.charAt(0).toUpperCase() + safeStatus.slice(1);
        statusBadge.textContent = statusText;
        detailsStatus.textContent = statusText;
        statusBadge.className = 'badge fs-6 ';

        if (safeStatus === 'completed') {
            statusBadge.classList.add('bg-success');
            showNotification('Scraping job completed successfully!', 'success');
            ensureActionsForCompletion();
        } else if (safeStatus === 'failed') {
            statusBadge.classList.add('bg-danger');
            showNotification('Scraping job failed. Please check the error message.', 'error');
        } else if (safeStatus === 'interrupted') {
            statusBadge.classList.add('bg-warning', 'text-dark');
            showNotification('Scraping job was interrupted.', 'warning');
        } else {
            statusBadge.classList.add('bg-info');
        }

        if ((safeStatus === 'failed' || safeStatus === 'interrupted') && errorSection && errorMessageEl) {
            if (errorMessage) {
                errorMessageEl.textContent = errorMessage;
                errorSection.classList.remove('d-none');
            } else {
                errorSection.classList.add('d-none');
            }
        } else if (errorSection) {
            errorSection.classList.add('d-none');
        }

        if (progressBar && (safeStatus === 'completed' || safeStatus === 'failed' || safeStatus === 'interrupted')) {
            progressBar.classList.remove('progress-bar-animated');
        }
    }

    function updateProgress(progressValue, resultCount) {
        const numericProgress = typeof progressValue === 'number' ? progressValue : 0;
        const boundedProgress = Math.min(Math.max(numericProgress, 0), 100);
        if (progressBar) {
            progressBar.style.width = boundedProgress + '%';
            progressBar.setAttribute('data-progress', boundedProgress);
        }
        if (progressText && typeof numericProgress === 'number') {
            progressText.textContent = numericProgress.toFixed(1) + '%';
        }
        if (resultCountEl && typeof resultCount === 'number') {
            resultCountEl.textContent = resultCount;
        }
    }

    function renderMetrics(data) {
        if (!etaElement || !data) {
            return;
        }
        let etaText = 'ETA: calculating...';
        if (typeof data.eta_seconds === 'number' && data.eta_seconds >= 0) {
            const minutes = Math.floor(data.eta_seconds / 60);
            const seconds = Math.floor(data.eta_seconds % 60);
            etaText = `ETA: ${minutes}m ${seconds}s`;
        }
        let throughputText = '';
        if (typeof data.throughput_per_minute === 'number' && data.throughput_per_minute > 0) {
            throughputText = `${data.throughput_per_minute.toFixed(1)} rows/min`;
        }
        etaElement.textContent = throughputText ? `${etaText} Â· ${throughputText}` : etaText;
    }

    socket.on('job_progress', function(data) {
        if (data.job_id !== jobId) {
            return;
        }
        updateStatus(data.status, data.error_message);
        updateProgress(data.progress || 0, data.result_count);
        if (data.end_time && endTimeElement) {
            endTimeElement.textContent = data.end_time;
        }
        if (latestMetrics) {
            renderMetrics(latestMetrics);
        }
    });

    socket.on('job_metrics', function(data) {
        if (data.job_id !== jobId) {
            return;
        }
        latestMetrics = data;
        renderMetrics(data);
    });

    socket.on('job_record_batch', function(data) {
        if (data.job_id !== jobId) {
            return;
        }
        latestPreviewRecords = data.preview || data.records || [];
    });

    window.previewResults = function previewResults() {
        const modal = new bootstrap.Modal(document.getElementById('previewModal'));
        modal.show();

        fetch(`/preview/${jobId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('preview-content').innerHTML =
                        `<div class="alert alert-danger">${data.error}</div>`;
                    return;
                }

                const rowsToRender = data.data && data.data.length ? data.data : latestPreviewRecords;
                const columns = data.columns && data.columns.length
                    ? data.columns
                    : (rowsToRender[0] ? Object.keys(rowsToRender[0]) : []);
                const totalRows = typeof data.total_rows === 'number' ? data.total_rows : rowsToRender.length;

                let html = `
                    <div class="mb-3">
                        <strong>Total Rows:</strong> ${totalRows} |
                        <strong>Showing:</strong> ${Math.min(rowsToRender.length, 10)} rows
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-sm">
                            <thead class="table-dark">
                                <tr>
                `;
                columns.forEach(col => {
                    html += `<th>${col}</th>`;
                });
                html += '</tr></thead><tbody>';

                rowsToRender.slice(0, 10).forEach(row => {
                    html += '<tr>';
                    columns.forEach(col => {
                        let value = row[col] ?? '';
                        if (typeof value === 'string' && value.length > 50) {
                            value = `${value.substring(0, 50)}...`;
                        }
                        html += `<td>${value}</td>`;
                    });
                    html += '</tr>';
                });

                html += '</tbody></table></div>';
                document.getElementById('preview-content').innerHTML = html;
            })
            .catch(error => {
                document.getElementById('preview-content').innerHTML =
                    `<div class="alert alert-danger">Error loading preview: ${error.message}</div>`;
            });
    };
});
</script>
{% endblock %}