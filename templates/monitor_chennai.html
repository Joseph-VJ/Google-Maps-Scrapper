{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h4><i class="fas fa-map-marked-alt"></i> Chennai Area Scraping Monitor</h4>
                <p class="mb-0">Job ID: {{ job.job_id }}</p>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-4">
                        <h6><i class="fas fa-store"></i> Business Type:</h6>
                        <p class="text-muted">{{ job.business_type.title() }}</p>
                    </div>
                    <div class="col-md-4">
                        <h6><i class="fas fa-map"></i> Total Areas:</h6>
                        <p class="text-muted">{{ job.total_areas }}</p>
                    </div>
                    <div class="col-md-4">
                        <h6><i class="fas fa-file"></i> Output File:</h6>
                        <p class="text-muted">{{ job.output_file }}</p>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6><i class="fas fa-list-ol"></i> Results Per Area:</h6>
                        <p class="text-muted">{{ job.results_per_area }}</p>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-calculator"></i> Expected Total:</h6>
                        <p class="text-muted">{{ job.total_results }}</p>
                    </div>
                </div>

                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6><i class="fas fa-chart-line"></i> Overall Progress</h6>
                        <span id="status-badge" class="badge bg-primary">{{ job.status.title() }}</span>
                    </div>
                    <div class="progress mb-2">
                        <div id="progress-bar" 
                             class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" 
                             style="width: {{ job.progress }}%">
                            <span id="progress-text">{{ "%.1f"|format(job.progress) }}%</span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <small class="text-muted">
                                <i class="fas fa-check"></i> Areas Completed: 
                                <span id="completed-areas">{{ job.completed_areas }}</span>/{{ job.total_areas }}
                            </small>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted">
                                <i class="fas fa-map-pin"></i> Current Area: 
                                <span id="current-area">{{ job.current_area or "Starting..." }}</span>
                            </small>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted">
                                <i class="fas fa-database"></i> Results Found: 
                                <span id="result-count">{{ job.result_count }}</span>
                            </small>
                            <small id="eta-info" class="text-muted d-block"></small>
                        </div>
                    </div>
                </div>

                <!-- Selected Areas Display -->
                <div class="mb-4">
                    <h6><i class="fas fa-list"></i> Selected Areas:</h6>
                    <div class="card">
                        <div class="card-body">
                            <div class="row" id="area-badge-container">
                                {% for area in job.areas %}
                                    <div class="col-md-3 mb-2">
                                        <span class="badge bg-light text-dark">
                                            {% if loop.index0 < job.completed_areas %}
                                                <i class="fas fa-check text-success"></i>
                                            {% elif area == job.current_area %}
                                                <i class="fas fa-spinner fa-spin text-primary"></i>
                                            {% else %}
                                                <i class="fas fa-clock text-muted"></i>
                                            {% endif %}
                                            {{ area }}
                                        </span>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <div id="job-info" class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-clock"></i> Started:</h6>
                        <p class="text-muted" id="start-time">{{ job.start_time.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-flag-checkered"></i> Completed:</h6>
                        <p class="text-muted" id="end-time">
                            {% if job.end_time %}
                                {{ job.end_time.strftime('%Y-%m-%d %H:%M:%S') }}
                            {% else %}
                                In progress...
                            {% endif %}
                        </p>
                    </div>
                </div>

                <div id="error-section" class="alert alert-danger d-none">
                    <h6><i class="fas fa-exclamation-triangle"></i> Error:</h6>
                    <p id="error-message" class="mb-0"></p>
                </div>

                <div id="action-buttons" class="mt-4">
                    {% if job.status == 'completed' %}
                        <a href="{{ url_for('download_results', job_id=job.job_id) }}" 
                           class="btn btn-success me-2">
                            <i class="fas fa-download"></i> Download Results
                        </a>
                        <button type="button" 
                                class="btn btn-info me-2" 
                                onclick="previewResults()">
                            <i class="fas fa-eye"></i> Preview Results
                        </button>
                    {% endif %}
                    <a href="{{ url_for('chennai') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Chennai Scraper
                    </a>
                    <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-home"></i> Home
                    </a>
                </div>
            </div>
        </div>

        <!-- Results Preview Modal -->
        <div class="modal fade" id="previewModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-table"></i> Chennai Results Preview
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div id="preview-content">
                            <div class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const jobId = '{{ job.job_id }}';
    const socket = io();

    const statusBadge = document.getElementById('status-badge');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const completedAreasEl = document.getElementById('completed-areas');
    const currentAreaEl = document.getElementById('current-area');
    const resultCountEl = document.getElementById('result-count');
    const endTimeEl = document.getElementById('end-time');
    const errorSection = document.getElementById('error-section');
    const errorMessageEl = document.getElementById('error-message');
    const etaInfoEl = document.getElementById('eta-info');
    const actionButtons = document.getElementById('action-buttons');
    const areaBadgeContainer = document.getElementById('area-badge-container');
    let latestPreviewRecords = [];

    const initialProgress = parseFloat("{{ job.progress }}");
    if (progressBar && !Number.isNaN(initialProgress)) {
        progressBar.style.width = initialProgress + '%';
        progressBar.setAttribute('data-progress', initialProgress);
        if (progressText) {
            progressText.textContent = initialProgress.toFixed(1) + '%';
        }
    }

    function ensureDownloadActions() {
        if (!actionButtons) {
            return;
        }
        if (!document.querySelector(`a[href="/download/${jobId}"]`)) {
            actionButtons.innerHTML = `
                <a href="/download/${jobId}" class="btn btn-success me-2">
                    <i class="fas fa-download"></i> Download Results
                </a>
                <button type="button" class="btn btn-info me-2" onclick="previewResults()">
                    <i class="fas fa-eye"></i> Preview Results
                </button>
                <a href="/chennai" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Chennai Scraper
                </a>
                <a href="/" class="btn btn-outline-secondary">
                    <i class="fas fa-home"></i> Home
                </a>
            `;
        }
    }

    function updateAreaBadges(completedAreas, currentArea) {
        if (!areaBadgeContainer) {
            return;
        }
        const badges = areaBadgeContainer.querySelectorAll('.badge');
        badges.forEach((badge, index) => {
            const icon = badge.querySelector('i');
            if (!icon) {
                return;
            }
            const areaName = badge.textContent.trim();
            if (typeof completedAreas === 'number' && index < completedAreas) {
                icon.className = 'fas fa-check text-success';
            } else if (currentArea && areaName === currentArea) {
                icon.className = 'fas fa-spinner fa-spin text-primary';
            } else {
                icon.className = 'fas fa-clock text-muted';
            }
        });
    }

    function updateStatus(status, errorMessage) {
        if (!statusBadge) {
            return;
        }
        const safeStatus = status || 'running';
        statusBadge.className = 'badge fs-6 ';
        statusBadge.textContent = safeStatus.charAt(0).toUpperCase() + safeStatus.slice(1);
        if (safeStatus === 'completed') {
            statusBadge.classList.add('bg-success');
            if (typeof showNotification === 'function') {
                showNotification('Chennai scraping job completed successfully!', 'success');
            }
            ensureDownloadActions();
        } else if (safeStatus === 'failed') {
            statusBadge.classList.add('bg-danger');
            if (typeof showNotification === 'function') {
                showNotification('Chennai scraping job failed. Please review the error details.', 'error');
            }
        } else if (safeStatus === 'interrupted') {
            statusBadge.classList.add('bg-warning', 'text-dark');
            if (typeof showNotification === 'function') {
                showNotification('Chennai scraping job was interrupted.', 'warning');
            }
        } else {
            statusBadge.classList.add('bg-primary');
        }

        if ((safeStatus === 'failed' || safeStatus === 'interrupted') && errorSection && errorMessageEl) {
            if (errorMessage) {
                errorMessageEl.textContent = errorMessage;
                errorSection.classList.remove('d-none');
            } else {
                errorSection.classList.add('d-none');
            }
        } else if (errorSection) {
            errorSection.classList.add('d-none');
        }
    }

    socket.on('job_progress', function(data) {
        if (data.job_id !== jobId) {
            return;
        }
        updateStatus(data.status, data.error_message);

        if (progressBar && typeof data.progress === 'number') {
            const boundedProgress = Math.min(Math.max(data.progress, 0), 100);
            progressBar.style.width = boundedProgress + '%';
            progressBar.setAttribute('data-progress', boundedProgress);
            if (progressText) {
                progressText.textContent = boundedProgress.toFixed(1) + '%';
            }
        }

        if (typeof data.completed_areas === 'number' && completedAreasEl) {
            completedAreasEl.textContent = data.completed_areas;
        }
        if (data.current_area && currentAreaEl) {
            currentAreaEl.textContent = data.current_area;
        }
        if (typeof data.result_count === 'number' && resultCountEl) {
            resultCountEl.textContent = data.result_count;
        }
        if (data.end_time && endTimeEl) {
            endTimeEl.textContent = data.end_time;
        }

        updateAreaBadges(data.completed_areas, data.current_area);

        if (progressBar && ['completed', 'failed', 'interrupted'].includes(data.status)) {
            progressBar.classList.remove('progress-bar-animated');
        }
    });

    socket.on('job_metrics', function(data) {
        if (data.job_id !== jobId || !etaInfoEl) {
            return;
        }
        const parts = [];
        if (typeof data.throughput_per_minute === 'number' && data.throughput_per_minute > 0) {
            parts.push(`${data.throughput_per_minute.toFixed(1)} rows/min`);
        }
        if (typeof data.eta_seconds === 'number' && data.eta_seconds >= 0) {
            const minutes = Math.floor(data.eta_seconds / 60);
            const seconds = Math.floor(data.eta_seconds % 60);
            parts.push(`ETA: ${minutes}m ${seconds}s`);
        }
        etaInfoEl.textContent = parts.join(' Â· ');
    });

    socket.on('job_record_batch', function(data) {
        if (data.job_id !== jobId) {
            return;
        }
        latestPreviewRecords = data.preview || data.records || [];
    });

    window.previewResults = function previewResults() {
        const modal = new bootstrap.Modal(document.getElementById('previewModal'));
        modal.show();

        fetch(`/preview/${jobId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('preview-content').innerHTML =
                        `<div class="alert alert-danger">${data.error}</div>`;
                    return;
                }

                const rowsToRender = data.data && data.data.length ? data.data : latestPreviewRecords;
                const columns = data.columns && data.columns.length
                    ? data.columns
                    : (rowsToRender[0] ? Object.keys(rowsToRender[0]) : []);
                const totalRows = typeof data.total_rows === 'number' ? data.total_rows : rowsToRender.length;

                let html = `
                    <div class="mb-3">
                        <strong>Total Rows:</strong> ${totalRows} |
                        <strong>Showing:</strong> ${Math.min(rowsToRender.length, 10)} rows
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-sm">
                            <thead class="table-dark">
                                <tr>
                `;
                columns.forEach(col => {
                    html += `<th>${col}</th>`;
                });
                html += '</tr></thead><tbody>';

                rowsToRender.slice(0, 10).forEach(row => {
                    html += '<tr>';
                    columns.forEach(col => {
                        let value = row[col] ?? '';
                        if (typeof value === 'string' && value.length > 50) {
                            value = `${value.substring(0, 50)}...`;
                        }
                        html += `<td>${value}</td>`;
                    });
                    html += '</tr>';
                });

                html += '</tbody></table></div>';
                document.getElementById('preview-content').innerHTML = html;
            })
            .catch(error => {
                document.getElementById('preview-content').innerHTML =
                    `<div class="alert alert-danger">Error loading preview: ${error.message}</div>`;
            });
    };
});
</script>
{% endblock %}
